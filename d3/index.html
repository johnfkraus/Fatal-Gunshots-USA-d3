<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .land {
        fill: #ddd;
    }

    .border {
        fill: none;
        stroke: #fff;
        stroke-linejoin: round;
        stroke-linecap: round;
    }

    .bubble {
        fill-opacity: .5;
        stroke: #fff;
        stroke-width: .5px;
    }

    .bubble :hover {
        fill-opacity: .1;
        stroke: #000;
    }

    .legend circle {
        fill: none;
        stroke: #ccc;
    }

    .legend text {
        fill: #777;
        font: 10px sans-serif;
        text-anchor: middle;
    }
</style>

<body>
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script>

        var w = window.innerWidth;
        var h = window.innerHeight;

        var width = 960,
            height = 600;

        var path = d3.geo.path()
            .projection(null);

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        var radius = d3.scale.sqrt()
            .domain([0, 1e6])
            .range([0, 18]);

        var tooltip = d3.select('body')
            .append('div')
            .style('position', 'absolute')
            .style('padding', '0 10px')
            .style('background', 'white')
            .style('opacity', 0);

        var focusedBubble = null;

        d3.json("data/us.json", function (error, us) {
            if (error) return console.error(error);

            console.log(us);

            svg.append("path")
                .datum(topojson.feature(us, us.objects.nation))
                .attr("class", "land")
                .attr("d", path);

            svg.append("path")
                .datum(topojson.mesh(us, us.objects.states, function (a, b) { return a !== b; }))
                .attr("class", "border border--state")
                .attr("d", path);

            svg.append("g")
                .attr("class", "bubble")
                .selectAll("circle")
                .data(topojson.feature(us, us.objects.counties).features
                    .sort(function (a, b) { return b.properties.population - a.properties.population; }))
                .enter().append("circle")
                .attr("transform", function (d) {
                    return "translate(" + path.centroid(d) + ")";
                })
                .attr("r", function (d) { return radius(d.properties.population); })

                .on('click', function (d) {
                    var current = d3.select(this);
                    console.log(current);

                    if(focusedBubble){
                        focusedBubble.transition().duration(1000)
                            .style('fill-opacity', .5)
                            .attr("r", function (d) { return radius(d.properties.population); })
                            .attr("transform", function (d) {
                                return "translate(" + path.centroid(d) + ")";
                            });
                    }
                    if(current.attr("r") > 100){
                        console.log("true");
                        current.transition().duration(1000)
                        .style('fill-opacity', .5)
                            .attr("r", function (d) { return radius(d.properties.population); })
                            .attr("transform", function (d) {
                                return "translate(" + path.centroid(d) + ")";
                            });
                    } else {
                    focusedBubble = current;

                    // tooltip.transition().duration(2000)
                    //     .style('opacity', .9)

                    // tooltip.html(
                    //     '<div style="font-size: 1rem; font-weight: bold">' +
                    //     '&deg;</div>'
                    // )
                    //     .style('left', (d3.event.pageX - 35) + 'px')
                    //     .style('top', (d3.event.pageY - 30) + 'px')

                    current.
                        transition().duration(1000)
                        .style('fill', 'black')
                        .style('fill-opacity', 1)
                        .attr("r", function (d) { return 200; })
                        .attr("transform", function (d) {
                            return "translate(" + [width/2, height/2] + ")";
                        })
                    }
                        
                    // .style('stroke-width', '3px')
                    // tempColor = this.style.fill;
                    // d3.select(this)
                    //     .style('fill', 'yellow')
                })

                .on('mouseover', function (d) {
                    tooltip.transition()
                        .style('opacity', .9)

                    tooltip.html(
                        '<div style="font-size: 1rem; font-weight: bold">' +
                        '&deg;</div>'
                    )
                        .style('left', (d3.event.pageX - 35) + 'px')
                        .style('top', (d3.event.pageY - 30) + 'px')
                })

                .on('mouseout', function (d) {
                    tooltip.html('');
                });

        });

        var legend = svg.append("g")
            .attr("class", "legend")
            .attr("transform", "translate(" + (width - 50) + "," + (height - 20) + ")")
            .selectAll("g")
            .data([1e4, 1e6, 3e6, 6e6])
            .enter().append("g");

        legend.append("circle")
            .attr("cy", function (d) { return -radius(d); })
            .attr("r", radius);

        legend.append("text")
            .attr("y", function (d) { return -2 * radius(d); })
            .attr("dy", "1.3em")
            .text(d3.format(".1s"));

    </script>